// Generated by CoffeeScript 1.10.0

/**
 * User
 * @description :: Model for storing users
 */
var moment;

moment = require('moment');

module.exports = {
  autoUpdatedAt: true,
  autoCreatedAt: true,
  autoPK: true,
  schema: true,
  attributes: {
    email: {
      type: 'email',
      unique: true
    },
    firstName: {
      type: 'string',
      defaultsTo: ''
    },
    lastName: {
      type: 'string',
      defaultsTo: ''
    },
    address: {
      type: 'text',
      defaultsTo: ''
    },
    dob: {
      type: 'string',
      defaultsTo: ''
    },
    dob_stamp: {
      type: 'datetime',
      defaultsTo: null
    },
    password: {
      type: 'string'
    },
    club_admin: {
      type: 'boolean',
      required: true,
      defaultsTo: false
    },
    team_admin: {
      type: 'boolean',
      required: true,
      defaultsTo: false
    },
    parent_email: {
      type: 'string',
      defaultsTo: ''
    },
    under_age: {
      type: 'boolean',
      defaultsTo: false
    },
    orgs: {
      collection: 'org',
      via: 'admins'
    },
    teams: {
      collection: 'team',
      via: 'manager'
    },
    user_orgs: {
      collection: 'org',
      via: 'org_members'
    },

    /* non admin attributes */
    user_events: {
      collection: 'event',
      via: 'event_user'
    },
    tokens: {
      collection: 'token',
      via: 'owner'
    },
    user_teams: {
      collection: 'team',
      via: 'team_members'
    },
    kids: {
      collection: 'user',
      via: 'parent',
      columnName: 'kid_id'
    },
    parent: {
      collection: 'user',
      via: 'kids',
      columnName: 'parent_id'
    },
    transactions: {
      collection: 'transaction',
      via: 'payee'
    },
    toJSON: function() {
      var obj;
      obj = this.toObject();
      delete obj.password;
      delete obj.socialProfiles;
      return obj;
    }
  },
  beforeCreate: function(values, next) {
    CipherService.hashPassword(values);
    next();
  },
  create_players: function(player_array, cb) {
    var Promise, i, len, player, x;
    Promise = require('q');
    x = new Array();
    for (i = 0, len = player_array.length; i < len; i++) {
      player = player_array[i];
      sails.log.debug("Parent email " + player[4]);
      Promise.all([
        User.create({
          under_age: true,
          parent_email: player[4],
          firstName: player[0],
          lastName: player[1],
          dob: player[3]
        }, {
          dob_stamp: moment(player[3], ["MM-DD-YYYY", "DD-MM", "DD-MM-YYYY"]).toISOString()
        }), User.findOne({
          email: player[4]
        })
      ]).spread(function(kid, parent) {
        sails.log.debug("Kid created " + (JSON.stringify(kid)));
        sails.log.debug("Parent found " + (JSON.stringify(parent)));
        parent.kids.add(kid);
        return parent.save(function(err, saved) {
          sails.log.debug("Parent saved " + (JSON.stringify(saved)));
          if (err != null) {
            return sails.log.debug("Parent saved err " + (JSON.stringify(err)));
          }
        });
      })["catch"](function(err) {
        if (err != null) {
          return sails.log.debug("Create player error " + (JSON.stringify(err)));
        }
      });
    }
    return cb(null, x);
  }
};
