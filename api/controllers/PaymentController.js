// Generated by CoffeeScript 1.10.0

/**
 * PaymentController
 *
 * @description :: Server-side logic for managing Payments
 * @help        :: See http://sailsjs.org/#!/documentation/concepts/Controllers
 */
var passport;

passport = require('passport');

module.exports = {
  create_payment: function(req, res) {
    var Stripe;
    sails.log.debug("Hit the Payment controller/create_payment");
    Stripe = require("stripe")(sails.config.stripe.stripe_secret);
    return Stripe.customers.create({
      source: req.body.stripe_token,
      description: 'hello'
    }).then(function(customer) {
      sails.log.debug("Stripe customer " + (JSON.stringify(customer)));
      return Stripe.charges.create({
        amount: parseInt(req.body.amount) * 100,
        currency: 'eur',
        customer: customer.id
      }).then((function(charge) {
        sails.log.debug("charge " + req.body.user_id);
        return User.update({
          id: req.body.user_id
        }, {
          stripe_token: charge.customer
        }).then((function(updated) {
          sails.log.debug("User updated " + (JSON.stringify(updated)));
          return res.json(200, {
            charge: charge,
            message: 'Tokens purchased successfully'
          });
        }), function(errResponse) {
          sails.log.debug("User update error " + (JSON.stringify(errResponse)));
          return res.serverError(errResponse);
        });
      }));
    })["catch"](function(err) {
      sails.log.debug("errrooror " + (JSON.stringify(err.message)));
      return res.serverError(406, {
        message: err.message
      });
    });
  }
};
